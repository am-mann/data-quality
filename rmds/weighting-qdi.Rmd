---
title: "Generate data quality index"
output: html_notebook
---
Standardize counties
```{r}
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 0 Â· Setup â€“ packages, paths, helpers
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
required <- c("readr", "dplyr", "stringr", "tibble")
missing  <- setdiff(required, rownames(installed.packages()))
if (length(missing)) install.packages(missing)
invisible(lapply(required, library, character.only = TRUE))

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1 Â· Read data
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
dq <- read_csv(here("data", "county_year_quality_metrics.csv"),
               show_col_types = FALSE) 
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2 Â· Build lookup tables
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
## 2a Â· State-abbr âœ 2-digit state FIPS (for 2003+ rows)
state_fips_lookup <- tibble::tribble(
  ~state_abbr, ~state_fips,
  "AL","01","AK","02","AZ","04","AR","05","CA","06","CO","08","CT","09",
  "DE","10","DC","11","FL","12","GA","13","HI","15","ID","16","IL","17",
  "IN","18","IA","19","KS","20","KY","21","LA","22","ME","23","MD","24",
  "MA","25","MI","26","MN","27","MS","28","MO","29","MT","30","NE","31",
  "NV","32","NH","33","NJ","34","NM","35","NY","36","NC","37","ND","38",
  "OH","39","OK","40","OR","41","PA","42","RI","44","SC","45","SD","46",
  "TN","47","TX","48","UT","49","VT","50","VA","51","WA","53","WV","54",
  "WI","55","WY","56","PR","72"
)

## 2b Â· Historical NCHS state codes âœ state FIPS (for â‰¤ 2002 rows)
nchs_to_state_fips <- tibble::tribble(
  ~nchs_code, ~state_fips,
  "01","01","02","02","03","04","04","05","05","06","06","08",
  "07","09","08","10","09","11","10","12","11","13","12","15",
  "13","16","14","17","15","18","16","19","17","20","18","21",
  "19","22","20","23","21","24","22","25","23","26","24","27",
  "25","28","26","29","27","30","28","31","29","32","30","33",
  "31","34","32","35","33","36","34","37","35","38","36","39",
  "37","40","38","41","39","42","40","44","41","45","42","46",
  "43","47","44","48","45","49","46","50","47","51","48","53",
  "49","54","50","55","51","56","52","72"
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3 Â· Generate a unified 5-digit FIPS code
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
dq <- dq %>%
  mutate(
    year            = as.integer(year),
    id_raw          = as.character(countyrs),              # original mixed-format field
    state_part_pre  = substr(id_raw, 1, 2),                # first two chars for both schemes
    county_part_pre = substr(id_raw, 3, 5),                # trailing three chars (always county code)

    # ---- old scheme (â‰¤ 2002) ----
    fips_old = if_else(
      year <= 2002,
      paste0(
        nchs_to_state_fips$state_fips[
          match(state_part_pre, nchs_to_state_fips$nchs_code)
        ],
        county_part_pre
      ),
      NA_character_
    ),

    # ---- new scheme (â‰¥ 2003) ----
    state_abbr      = if_else(year >= 2003, state_part_pre, NA_character_),
    county_part_new = if_else(year >= 2003, county_part_pre, NA_character_)
  ) %>%
  left_join(state_fips_lookup, by = "state_abbr") %>%      # brings in 2-digit FIPS for new rows
  mutate(
    fips_new = if_else(year >= 2003, paste0(state_fips, county_part_new), NA_character_),
    fips     = coalesce(fips_old, fips_new) %>% str_pad(5, pad = "0")   # final 5-digit code
  ) %>%
  select(-starts_with("state_"), -starts_with("county_part"), -fips_old, -fips_new)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4 Â· (Optional) sanity checks
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
## 4a Â· any missing FIPS?
sum(is.na(dq$fips))                           # should be 0

## 4b Â· length check
all(str_length(dq$fips) == 5)                 # should be TRUE

# At this point `dq` contains a clean `fips` column you can use in joins,
# mapping, or IHME stable-FIPS merges.
```

Make high_quality_counties.csv
```{r}
###############################################################################
##  high_quality_counties.R
##
##  Create a list of â€œgold-standardâ€ counties for the simulation experiment.
##  Criteria  =  county is in the *lowest 10 % (best decile)* on every
##               error-type indicator you track.
##
##  Edit only the three â€œUSER INPUTâ€ lines below.
###############################################################################

library(tidyverse)

## â”€â”€ USER INPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
indicators_file <- "/path/to/county_indicators_2021.csv"  # one row per county
year_of_interest <- 2021                                  # baseline year
out_file         <- "high_quality_counties.csv"           # output list
## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

## 1 Â· Read indicator table  --------------------------------------------------
## Expected columns (names can be adapted):
ind <- dq

# Sanity check
expected_cols <- c("countyrs", "prop_garbage", "prop_light",
                   "pct_acc_miss", "pct_overd_miss")
stopifnot(all(expected_cols %in% names(ind)))

## 2 Â· Compute 10th-percentile thresholds (lower = better) --------------------
thresholds <- ind %>%
  summarise(across(all_of(expected_cols[-1]), ~ quantile(.x, 0.10, na.rm = TRUE)))

## 3 Â· Select counties that beat all thresholds -------------------------------
hq <- ind %>%
  filter(
    prop_garbage <= thresholds$prop_garbage,
    prop_light   <= thresholds$prop_light,
    pct_overd_miss <= thresholds$pct_overd_miss,
    pct_acc_miss  <= thresholds$pct_acc_miss) %>%
  distinct(countyrs) %>%
  arrange(countyrs)

## 4 Â· Write the list (one FIPS per line) -------------------------------------
write_csv(hq, here("data_raw", out_file), col_names = FALSE)
cat("Saved", nrow(hq), here("data_raw", out_file), "\n")
```

run simulation
```{r}
# 0 Â· Libraries & parallel --------------------------------------------------
# ğŸ“¦ Load libraries
library(arrow)
library(dplyr)
library(stringr)
library(data.table)
library(here)

# ğŸ“ Define paths
parquet_file <- here("data_private/mcod_sample", "mcod_2016.parquet")
hq_file <- here("data_raw", "high_quality_counties.csv")

# ğŸ“¥ Load high-quality counties and pad to 5-digit FIPS
hq_fips <- readr::read_csv(hq_file, col_names = FALSE, show_col_types = FALSE) |>
  pull(X1) |>
  as.character() |>
  stringr::str_pad(5, side = "left", pad = "0")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“ County-ID harmoniser (handles old â‰¤ 2002 & new â‰¥ 2003 schemes)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

## 1 Â· Lookup tables --------------------------------------------------------
state_fips_lookup <- tibble::tribble(
  ~state_abbr, ~state_fips,
  "AL","01","AK","02","AZ","04","AR","05","CA","06","CO","08","CT","09",
  "DE","10","DC","11","FL","12","GA","13","HI","15","ID","16","IL","17",
  "IN","18","IA","19","KS","20","KY","21","LA","22","ME","23","MD","24",
  "MA","25","MI","26","MN","27","MS","28","MO","29","MT","30","NE","31",
  "NV","32","NH","33","NJ","34","NM","35","NY","36","NC","37","ND","38",
  "OH","39","OK","40","OR","41","PA","42","RI","44","SC","45","SD","46",
  "TN","47","TX","48","UT","49","VT","50","VA","51","WA","53","WV","54",
  "WI","55","WY","56","PR","72"
)

nchs_to_state_fips <- tibble::tribble(
  ~nchs_code, ~state_fips,
  "01","01","02","02","03","04","04","05","05","06","06","08",
  "07","09","08","10","09","11","10","12","11","13","12","15",
  "13","16","14","17","15","18","16","19","17","20","18","21",
  "19","22","20","23","21","24","22","25","23","26","24","27",
  "25","28","26","29","27","30","28","31","29","32","30","33",
  "31","34","32","35","33","36","34","37","35","38","36","39",
  "37","40","38","41","39","42","40","44","41","45","42","46",
  "43","47","44","48","45","49","46","50","47","51","48","53",
  "49","54","50","55","51","56","52","72"
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ—ï¸  Add overdose / accident / mechanism / light flags to truth_df
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
dictionary_dir <- here("data_raw", "cause-codes")   # adjust if different

## 1 Â· Look-ups ---------------------------------------------------------------
canonical_icd <- function(x) stringr::str_remove_all(
  stringr::str_to_upper(x), "[^A-Z0-9]"
)

# Garbage codes
garbage_codes <- readr::read_csv(
  file.path(dictionary_dir, "gbd_garbage_codes_without_overdose.csv"),
  show_col_types = FALSE
)$icd10 %>%
  canonical_icd() %>%
  substr(1, 3) %>%
  unique()

# Overdose codes
overdose_ucod <- readr::read_csv(
  file.path(dictionary_dir, "overdose-detail-codes-v3.csv"),
  show_col_types = FALSE
)$ucod %>%
  canonical_icd() %>%
  substr(1, 3) %>%
  unique()

# â€¢ Accident UCOD â†” detail look-up
acc_lkp <- readr::read_csv(
  file.path(dictionary_dir, "accident-detail-codes-v3.csv"),
  show_col_types = FALSE
) %>%
  tidyr::pivot_longer(starts_with("detail_"),
                      values_to = "detail",
                      values_drop_na = TRUE) %>%
  transmute(
    ucod   = canonical_icd(stringr::str_trim(ucod)),
    detail = canonical_icd(stringr::str_trim(detail))
  ) %>%
  filter(detail != "") %>%
  distinct()

accident_ucod_set   <- unique(acc_lkp$ucod)
accident_detail_set <- unique(acc_lkp$detail)
accident_ucod_set <- substr(accident_ucod_set, 1, 3)


## 2 Â· Compute flags ----------------------------------------------------------
sec_cols <- paste0("record_", 1:20)
present_sec <- intersect(sec_cols, names(truth_df))


# âœ… Load and filter truth data
truth_df <- arrow::read_parquet(parquet_file) %>%
  as_tibble() %>%
  normalize_county_fips() %>%
  filter(countyrs_fips %in% hq_fips) %>%
  as.data.table()

truth_df <- truth_df %>%
  mutate(
    icd10 = canonical_icd(ucod),
    icd10_3 = substr(icd10, 1, 3),  
    n_mcod = rowSums(!is.na(select(., all_of(present_sec)))),   # # of MCODs
      is_overdose = icd10_3 %in% overdose_ucod,
    is_accident = icd10_3 %in% accident_ucod_set,
    ranum = row_number()
  )

sec_cols <- paste0("record_", 1:20)
present_sec <- intersect(sec_cols, names(truth_df))

# Canonicalize + truncate to 3 characters
for (col in present_sec) {
  truth_df[[col]] <- truth_df[[col]] %>%
    canonical_icd() %>%
    substr(1, 3)
}

# ---- pull all contributing causes into long form ----
contrib_long <- purrr::map_dfr(
  present_sec,
  ~ truth_df %>%
      select(ranum, detail_raw = all_of(.x))
) %>%
  mutate(detail = canonical_icd(detail_raw)) %>%
  filter(!is.na(detail_raw) & trimws(detail_raw) != "")

# ---- *Overdose* flag: has a specific T-code -----------------
unspec_tbl <- contrib_long %>%
  filter(stringr::str_starts(detail, "T")) %>%
  mutate(
    is_specific = !(stringr::str_starts(detail, "T509") |
                    stringr::str_starts(detail, "T409"))
  ) %>%
  group_by(ranum) %>%
  summarise(has_specific_T = any(is_specific), .groups = "drop")

# ---- *Accident* flag: has required mechanism detail ----------
req_mech_tbl <- contrib_long %>%
  semi_join(acc_lkp, by = "detail") %>%
  left_join(truth_df %>% select(ranum, icd10_3), by = "ranum") %>%
  semi_join(acc_lkp, by = c("icd10_3" = "ucod", "detail")) %>%
  distinct(ranum) %>%
  mutate(has_mechanism = TRUE)

# ---- Merge back into truth_df --------------------------------
truth_df <- truth_df %>%
  left_join(unspec_tbl, by = "ranum") %>%
  left_join(req_mech_tbl, by = "ranum") %>%
  mutate(
    has_specific_T = tidyr::replace_na(has_specific_T, FALSE),
    has_mechanism  = tidyr::replace_na(has_mechanism, FALSE)
  ) %>%
  select(-ranum)  # cleanup

## 2 Â· Normaliser -----------------------------------------------------------
normalize_county_fips <- function(df) {
  # â¬‡ ensure â€˜yearâ€™ exists (constant for single-year files like mcod_2016)
  if (!"year" %in% names(df)) df <- dplyr::mutate(df, year = 2016L)

  df %>%
    mutate(
      countyrs_chr = as.character(countyrs),
      state_part   = substr(countyrs_chr, 1, 2),
      county_part  = substr(countyrs_chr, 3, 5),

      ## old NCHS format (â‰¤ 2002)  â†’ use nchs_to_state_fips
      fips_old = if_else(
        year <= 2002,
        paste0(
          nchs_to_state_fips$state_fips[
            match(state_part, nchs_to_state_fips$nchs_code)
          ],
          county_part
        ),
        NA_character_
      ),

      ## new â€œTX317â€ style (â‰¥ 2003) â†’ state_abbr lookup
      state_abbr = if_else(year >= 2003, state_part, NA_character_)
    ) %>%
    left_join(state_fips_lookup, by = "state_abbr") %>%
    mutate(
      fips_new = if_else(year >= 2003,
                         paste0(state_fips, county_part),
                         NA_character_),
      countyrs_fips = coalesce(fips_old, fips_new) %>% stringr::str_pad(5, pad = "0")
    ) %>%
    select(-state_part, -county_part, -state_abbr,
           -state_fips, -fips_old, -fips_new)
}

# ğŸ” Confirm number of rows after filtering
cat("\nâœ… Filtered truth_df loaded:\n")
cat("  - Rows:", nrow(truth_df), "\n")
cat("  - Sample FIPS:", head(truth_df$countyrs_fips), "\n")

cat("\nâœ” Loaded truth_df\n")
cat("  - Rows:", nrow(truth_df), "\n")
cat("  - Sample FIPS:", head(truth_df$countyrs_fips), "\n")

# 4 Â· Indicator calculators -------------------------------------------------
calc_indicators <- function(dt) {
  list(
    prop_garbage   = mean(dt$icd10_3 %in% garbage_codes),
    prop_light     = mean(dt$n_mcod <= 1),
    pct_overd_miss = mean(dt$is_overdose & !dt$has_specific_T),
    pct_acc_miss   = mean(dt$is_accident & !dt$has_mechanism)
  ) |> unlist()
}

# 5 Â· Outcome generator -----------------------------------------------------
compute_outputs <- function(dt) {
  rates <- dt[, .N, by = ucr39][order(ucr39)]$N
  if (length(rates) < 5) rates <- c(rates, rep(0, 5 - length(rates)))
  rates
}
truth_outputs <- compute_outputs(truth_df)

# 6 Â· Error-injection modules ----------------------------------------------

inject_garbage <- function(dt, p) {
  idx <- which(!dt$icd10_3 %in% garbage_codes & runif(nrow(dt)) < p)
  dt[idx, ucod := sample(garbage_codes, .N, replace = TRUE)]
  dt[idx, icd10 := canonical_icd(ucod)]
  dt[idx, icd10_3 := substr(icd10, 1, 3)]
  dt
}

inject_light <- function(dt, p) {
  idx <- which(runif(nrow(dt)) < p)
  dt[idx, paste0("record_", 2:20) := ""]
  present_sec <- intersect(paste0("record_", 1:20), names(dt))
  dt[, n_mcod := rowSums(!is.na(.SD) & .SD != ""), .SDcols = present_sec]
  dt
}
inject_overdose <- function(dt, p) {
  idx <- which(dt$is_overdose & runif(nrow(dt)) < p)
  dt[idx, has_specific_T := FALSE]
  dt
}
inject_accident <- function(dt, p) {
  idx <- which(dt$is_accident & runif(nrow(dt)) < p)
  dt[idx, has_mechanism := FALSE]
  dt
}

# 7 Â· Diagnostic helpers ----------------------------------------------------
check_ucr39_change <- function(dt_original, dt_simulated) {
  tbl_orig <- dt_original[, .N, by = ucr39][order(ucr39)]
  tbl_sim  <- dt_simulated[, .N, by = ucr39][order(ucr39)]
  merged <- full_join(tbl_orig, tbl_sim, by = "ucr39", suffix = c("_orig", "_sim")) %>%
    replace_na(list(N_orig = 0, N_sim = 0)) %>%
    mutate(diff = N_sim - N_orig)
  total_change <- sum(abs(merged$diff))
  cat("  â€º ğŸ” Î” ucr39 record count:", total_change, "\n")
  invisible(total_change)
}

# 8 Â· One simulation draw ---------------------------------------------------
run_one_draw <- function(draw_id) {
  pars <- list(
    p_garb  = runif(1, 0, p_garb_max),
    p_light = runif(1, 0, p_light_max),
    p_over  = runif(1, 0, p_over_max),
    p_acc   = runif(1, 0, p_acc_max)
  )

  dt_sim <- copy(truth_df)
  dt_sim <- inject_garbage(dt_sim, pars$p_garb)
  dt_sim <- inject_light(dt_sim, pars$p_light)
  dt_sim <- inject_overdose(dt_sim, pars$p_over)
  dt_sim <- inject_accident(dt_sim, pars$p_acc)

  check_ucr39_change(truth_df, dt_sim)

  sim_outputs <- compute_outputs(dt_sim)
  err <- sqrt(mean((sim_outputs - truth_outputs)^2))

  if (all(sim_outputs == truth_outputs)) {
    cat("  â€º âš ï¸ sim_outputs identical to truth_outputs (no error injected)\n")
  } else {
    cat("  â€º âœ… sim_outputs differ from truth_outputs\n")
  }

  ind_vec <- calc_indicators(dt_sim)

  tibble::tibble(
    draw            = draw_id,
    err             = err,
    p_garb          = pars$p_garb,
    p_light         = pars$p_light,
    p_over          = pars$p_over,
    p_acc           = pars$p_acc,
    prop_garbage    = ind_vec["prop_garbage"],
    prop_light      = ind_vec["prop_light"],
    pct_overd_miss  = ind_vec["pct_overd_miss"],
    pct_acc_miss    = ind_vec["pct_acc_miss"]
  )
}
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ§ª Sanity checks for injection targets
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cat("\nğŸ§ª Sanity check: values in `truth_df`\n")

cat("  - Records with n_mcod <= 1 (light cert): ",
    sum(truth_df$n_mcod <= 1, na.rm = TRUE), "\n")

cat("  - Records with overdose flag: ",
    sum(truth_df$is_overdose, na.rm = TRUE), "\n")

cat("  - Records with accident flag: ",
    sum(truth_df$is_accident, na.rm = TRUE), "\n")

cat("  - Records with missing `has_specific_T`: ",
    sum(is.na(truth_df$has_specific_T)), "\n")

cat("  - Records with missing `has_mechanism`: ",
    sum(is.na(truth_df$has_mechanism)), "\n")

cat("  - Records with valid ucod: ",
    sum(!is.na(truth_df$ucod)), "\n")

cat("  - Sample ucod values:\n")
print(table(truth_df$ucod)[1:5])

cat("  - Sample garbage codes:\n")
print(head(garbage_codes))

# 9 Â· Run the simulation ----------------------------------------------------
furrr_opts <- furrr::furrr_options(seed = TRUE)

cat("\nğŸ§ª Diagnostic summary of injection conditions in truth_df:\n")

cat("  â€º Garbage injection eligible rows:\n")
cat("    - Eligible (non-garbage): ",
    sum(!truth_df$icd10 %in% garbage_codes), "/", nrow(truth_df), "\n")

cat("  â€º Light injection eligible rows:\n")
cat("    - All rows (unconditional): ", nrow(truth_df), "\n")

cat("  â€º Overdose injection eligible rows:\n")
cat("    - is_overdose == TRUE:      ",
    sum(truth_df$is_overdose), "\n")

cat("  â€º Accident injection eligible rows:\n")
cat("    - is_accident == TRUE:      ",
    sum(truth_df$is_accident), "\n")

cat("  â€º Additional sanity:\n")
cat("    - ucr39 unique values: ", length(unique(truth_df$ucr39)), "\n")


sim_tbl <- future_map_dfr(
  1:ndraws,
  run_one_draw,
  .progress = TRUE,
  .options = furrr_opts
)
readr::write_csv(sim_tbl, file.path(output_dir, "sim_draws.csv"))

# 10 Â· Regression -----------------------------------------------------------
cat("\nâœ” Simulation complete\n")
cat("  - sim_tbl rows:", nrow(sim_tbl), "\n")
sim_tbl %>% summarise(across(
  c(err, prop_garbage, prop_light, pct_overd_miss, pct_acc_miss),
  ~ sum(is.na(.))
)) %>% print()

cat("\n  - Summary of `err`:\n")
print(summary(sim_tbl$err))
```
```{r}
# ğŸ§ª Load high quality counties
hq_counties <- readr::read_csv(
  here::here("data_raw", "high_quality_counties.csv"),
  col_names = FALSE, show_col_types = FALSE
)

cat("\nâœ… First few rows of high-quality counties:\n")
print(head(hq_counties))

# ğŸ§ª Check format of hq_counties (are they 5-digit FIPS?)
cat("\nğŸ§ª Are these valid 5-digit numeric FIPS codes?\n")
print(hq_counties %>% mutate(X1 = as.character(X1)) %>% mutate(padded = stringr::str_pad(X1, 5, pad = "0")) %>% head())

# ğŸ§ª Load a small sample from the Parquet file
sample_df <- arrow::read_parquet(parquet_file, as_data_frame = TRUE) %>% head(10)

cat("\nâœ… Sample rows from Parquet file:\n")
print(sample_df)

# ğŸ§ª Check what `countyrs` looks like in Parquet file
cat("\nğŸ§ª Unique values from Parquet `countyrs` column (first 10):\n")
print(unique(sample_df$countyrs)[1:10])

# ğŸ§ª Try to normalize both to same format (if needed)
if ("countyrs" %in% names(sample_df)) {
  cat("\nğŸ§ª Normalizing `countyrs` column to 5-digit FIPS format:\n")
  print(sample_df %>%
    mutate(countyrs_chr = stringr::str_pad(as.character(countyrs), 5, pad = "0")) %>%
    select(countyrs, countyrs_chr))
}

# ğŸ§ª How many counties match?
hq_fips <- hq_counties$X1 %>% as.character() %>% stringr::str_pad(5, pad = "0")
truth_df_test <- arrow::read_parquet(parquet_file) %>%
  as_tibble() %>%
  mutate(countyrs = stringr::str_pad(as.character(countyrs), 5, pad = "0")) %>%
  filter(countyrs %in% hq_fips)

cat("\nğŸ§ª Number of matching rows in filtered truth_df:\n")
print(nrow(truth_df_test))

cat("\nğŸ§ª Sample FIPS codes from filtered truth_df:\n")
print(head(truth_df_test$countyrs))

```
```{r}
# What ICD codes are present?
cat("Unique 3-char UCODs in data:\n")
print(sort(unique(truth_df$icd10_3)))

# Compare with injection sets
cat("\nOverlap with garbage codes:\n")
print(intersect(truth_df$icd10_3, garbage_codes))

cat("\nOverlap with overdose codes:\n")
print(intersect(truth_df$icd10_3, overdose_ucod))

cat("\nOverlap with accident UCODs:\n")
print(intersect(truth_df$icd10_3, accident_ucod_set))

cat("\nğŸ“Š Potential rows for each injection:\n")

cat("  - Garbage eligible: ", sum(!truth_df$icd10_3 %in% garbage_codes), "\n")
cat("  - Overdose eligible: ", sum(truth_df$is_overdose), "\n")
cat("  - Accident eligible: ", sum(truth_df$is_accident), "\n")

```
 

