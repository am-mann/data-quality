---
title: "Mapping Notebook"
output: html_notebook
---

Make preliminary maps
```{r}
# ────────────────────────────────────────────────────────────────
# 0 · Setup – packages and helper options
# ────────────────────────────────────────────────────────────────
required <- c("sf", "tigris", "readr", "dplyr",
              "stringr", "tidyr", "purrr", "ggplot2",
              "viridis", "patchwork")

missing <- setdiff(required, rownames(installed.packages()))
if (length(missing)) install.packages(missing)
invisible(lapply(required, library, character.only = TRUE))

options(tigris_use_cache = TRUE, tigris_class = "sf")

# ────────────────────────────────────────────────────────────────
# 1 · Load county-year data
# ────────────────────────────────────────────────────────────────
dq <- read_csv("/Users/amymann/Documents/Data Quality Project/data_quality/county_year_quality_metrics.csv",
               show_col_types = FALSE)

# Extended state abbreviation to FIPS lookup
state_fips_lookup <- tibble::tribble(
  ~state_abbr, ~state_fips,
  "AL", "01", "AK", "02", "AZ", "04", "AR", "05", "CA", "06",
  "CO", "08", "CT", "09", "DE", "10", "DC", "11", "FL", "12",
  "GA", "13", "HI", "15", "ID", "16", "IL", "17", "IN", "18",
  "IA", "19", "KS", "20", "KY", "21", "LA", "22", "ME", "23",
  "MD", "24", "MA", "25", "MI", "26", "MN", "27", "MS", "28",
  "MO", "29", "MT", "30", "NE", "31", "NV", "32", "NH", "33",
  "NJ", "34", "NM", "35", "NY", "36", "NC", "37", "ND", "38",
  "OH", "39", "OK", "40", "OR", "41", "PA", "42", "RI", "44",
  "SC", "45", "SD", "46", "TN", "47", "TX", "48", "UT", "49",
  "VT", "50", "VA", "51", "WA", "53", "WV", "54", "WI", "55",
  "WY", "56", "PR", "72"
)

# Build 5-digit FIPS code
dq <- dq |>
  mutate(
    year = as.integer(year),
    state_abbr = if_else(year == 1999, NA_character_, substr(countyrs, 1, 2)),
    county_part = if_else(year == 1999, NA_character_, substr(countyrs, 3, 5))
  ) |>
  left_join(state_fips_lookup, by = "state_abbr") |>
  mutate(
    countyrs_fips = case_when(
      year == 1999 ~ str_pad(countyrs, 5, pad = "0"),
      TRUE ~ paste0(state_fips, county_part)
    )
  )

# ────────────────────────────────────────────────────────────────
# 2 · Load and transform counties (shrink/move AK & HI)
# ────────────────────────────────────────────────────────────────

# Helper: shift geometries
st_shift <- function(sf_obj, shift = c(0, 0)) {
  st_geometry(sf_obj) <- st_geometry(sf_obj) + shift
  sf_obj
}

# Helper: scale geometries around centroid
st_scale <- function(sf_obj, scale = 1) {
  centroid <- st_centroid(st_union(sf_obj))
  st_geometry(sf_obj) <- (st_geometry(sf_obj) - centroid) * scale + centroid
  sf_obj
}

# Load all counties, apply CRS upfront
us_counties <- counties(year = 2023, cb = TRUE, class = "sf") |>
  st_transform(2163) |>
  select(countyrs = GEOID, statefp = STATEFP)

# Split regions
mainland <- us_counties |> filter(!statefp %in% c("02", "15", "72"))  # 48 + DC
alaska   <- us_counties |> filter(statefp == "02") |>
  st_scale(0.35) |>
  st_shift(c(2500000, -2200000)) |>
  st_set_crs(2163)  # reattach CRS after transformation

hawaii <- us_counties |> filter(statefp == "15") |>
  st_scale(1.5) |>
  st_shift(c(5200000, -1400000)) |>
  st_set_crs(2163)  # reattach CRS after transformation

# Combine all regions safely
counties_sf <- bind_rows(mainland, alaska, hawaii)

# ────────────────────────────────────────────────────────────────
# 3 · Variables and years to map
# ────────────────────────────────────────────────────────────────
years_to_map <- c(1999, 2010, 2020, 2022)

vars_to_map <- c(
  "prop_garbage", "prop_light", "pct_acc_miss", "pct_overd_miss",
  "pct_overdose_unspec_k",
  "pct_marstat_comp_k", "pct_placdth_comp_k", "pct_educ_comp_k", "pct_mandeath_comp_k"
)

# ────────────────────────────────────────────────────────────────
# 4 · Mapping function
# ────────────────────────────────────────────────────────────────
make_map <- function(sf_data, var, title = NULL, palette = "plasma") {
  fill_scale <- if (var == "prop_garbage") {
    scale_fill_viridis_c(
      option = palette,
      na.value = "grey90",
      limits = c(0, 0.4),
      oob = scales::squish
    )
  } else {
    scale_fill_viridis_c(
      option = palette,
      na.value = "grey90"
    )
  }

  ggplot(sf_data) +
    geom_sf(aes(fill = .data[[var]]), color = NA) +
    fill_scale +
    coord_sf(
      xlim = c(-2500000, 2500000),   # crop longitude
      ylim = c(-2200000, 730000),    # crop latitude
      expand = FALSE
    ) +
    labs(
      title = title %||% var,
      fill = NULL
    ) +
    theme_void() +
    theme(
      plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
      legend.text = element_text(size = 9)
    )
}

# ────────────────────────────────────────────────────────────────
# 5 · Join each year’s data to shapefile
# ────────────────────────────────────────────────────────────────
joined_by_year <- map(set_names(as.character(years_to_map)), function(yr) {
  dq_sub <- dq |> filter(year == as.integer(yr)) |>
    select(countyrs_fips, all_of(vars_to_map))

  left_join(counties_sf, dq_sub, by = c("countyrs" = "countyrs_fips"))
})

# ────────────────────────────────────────────────────────────────
# 6 · Generate and save maps (1 per variable × year)
# ────────────────────────────────────────────────────────────────
output_dir <- "/Users/amymann/Documents/Data Quality Project/data_quality/figures"
dir.create(output_dir, showWarnings = FALSE)

walk(vars_to_map, function(var) {
  walk(names(joined_by_year), function(yr) {
    joined_sf <- joined_by_year[[yr]]
        # Identify counties with missing values (NA or NaN) for this variable
    missing <- joined_sf |>
      filter(is.na(.data[[var]]) | is.nan(.data[[var]])) |>
      pull(countyrs)
    
    if (length(missing) > 0) {
      cat("\nMissing values for", var, "in", win, ":\n")
      print(missing)
    }


    map_plot <- make_map(joined_sf, var = var, title = paste(var, yr))

    ggsave(
      filename = file.path(output_dir, paste0(var, "_", yr, ".png")),
      plot = map_plot,
      width = 8,
      height = 6,
      dpi = 320
    )
  })
})
```
5 year averages
```{r}
# ─────────────── Setup ───────────────
required <- c("sf", "tigris", "readr", "dplyr", "stringr", "tidyr",
              "purrr", "ggplot2", "viridis", "patchwork")
missing <- setdiff(required, rownames(installed.packages()))
if (length(missing)) install.packages(missing)
invisible(lapply(required, library, character.only = TRUE))
options(tigris_use_cache = TRUE, tigris_class = "sf")

# ─────────────── Load and preprocess data ───────────────
dq <- read_csv(here("data", "county_year_quality_metrics.csv"),
               show_col_types = FALSE)

# Define time window
dq <- dq |>
  mutate(
    year = as.integer(year),
    time_window = case_when(
      year >= 1999 & year <= 2004 ~ "1999_2004",
      year >= 2005 & year <= 2010 ~ "2005_2010",
      year >= 2011 & year <= 2017 ~ "2011_2017",
      year >= 2018 & year <= 2022 ~ "2018_2022",
      TRUE ~ NA_character_
    )
  )

# Convert VT015-style codes to FIPS
state_fips_lookup <- tibble::tribble(
  ~state_abbr, ~state_fips,
  "AL", "01", "AK", "02", "AZ", "04", "AR", "05", "CA", "06",
  "CO", "08", "CT", "09", "DE", "10", "DC", "11", "FL", "12",
  "GA", "13", "HI", "15", "ID", "16", "IL", "17", "IN", "18",
  "IA", "19", "KS", "20", "KY", "21", "LA", "22", "ME", "23",
  "MD", "24", "MA", "25", "MI", "26", "MN", "27", "MS", "28",
  "MO", "29", "MT", "30", "NE", "31", "NV", "32", "NH", "33",
  "NJ", "34", "NM", "35", "NY", "36", "NC", "37", "ND", "38",
  "OH", "39", "OK", "40", "OR", "41", "PA", "42", "RI", "44",
  "SC", "45", "SD", "46", "TN", "47", "TX", "48", "UT", "49",
  "VT", "50", "VA", "51", "WA", "53", "WV", "54", "WI", "55",
  "WY", "56", "PR", "72"
)

dq <- dq |>
  mutate(
    year = as.integer(year),
    countyrs_chr = as.character(countyrs),

    # Handle both 1999 and other years in one go
    countyrs_fips = case_when(
      year == 1999 ~ paste0(
        str_pad(substr(countyrs_chr, 1, nchar(countyrs_chr) - 3), 2, pad = "0"),
        str_pad(substr(countyrs_chr, nchar(countyrs_chr) - 2, nchar(countyrs_chr)), 3, pad = "0")
      ),
      TRUE ~ NA_character_
    ),

    state_abbr = if_else(year != 1999, substr(countyrs_chr, 1, 2), NA_character_),
    county_part = if_else(year != 1999, substr(countyrs_chr, 3, 5), NA_character_)
  ) |>
  left_join(state_fips_lookup, by = "state_abbr") |>
  mutate(
    # Fill in missing FIPS for non-1999 rows
    countyrs_fips = if_else(
      is.na(countyrs_fips),
      paste0(state_fips, county_part),
      countyrs_fips
    )
  )


# ─────────────── Shift and Scale helpers ───────────────
st_shift <- function(sf_obj, shift = c(0, 0)) {
  st_geometry(sf_obj) <- st_geometry(sf_obj) + shift
  sf_obj
}
st_scale <- function(sf_obj, scale = 1) {
  centroid <- st_centroid(st_union(sf_obj))
  st_geometry(sf_obj) <- (st_geometry(sf_obj) - centroid) * scale + centroid
  sf_obj
}

# ─────────────── Time-window-specific shapefiles ───────────────
shapefile_years <- c("1999_2004" = 2000, "2005_2010" = 2010,
                     "2011_2017" = 2014, "2018_2022" = 2021)

county_shapes_by_window <- map(shapefile_years, function(year) {
  us_counties <- counties(year = year, cb = TRUE, class = "sf") |>
    st_zm(drop = TRUE, what = "ZM") |>
    st_transform(2163)

  # Explicit GEOID fallback
  if ("GEOID" %in% names(us_counties)) {
    us_counties <- us_counties |> mutate(countyrs = GEOID)
  } else {
    us_counties <- us_counties |> mutate(
      countyrs = paste0(
        str_pad(as.character(STATE), 2, pad = "0"),
        str_pad(as.character(COUNTY), 3, pad = "0")
      )
    )
  }

  if ("STATEFP" %in% names(us_counties)) {
    us_counties <- us_counties |> mutate(statefp = STATEFP)
  } else if ("STATE" %in% names(us_counties)) {
    us_counties <- us_counties |> mutate(statefp = str_pad(as.character(STATE), 2, pad = "0"))
  } else {
    stop("No STATEFP or STATE in shapefile")
  }

  us_counties <- us_counties |> select(countyrs, statefp, geometry)

  mainland <- us_counties |> filter(!statefp %in% c("02", "15", "72"))
  alaska <- us_counties |> filter(statefp == "02") |> st_scale(0.4) |> st_shift(c(1300000, -4900000)) |> st_set_crs(2163)
  hawaii <- us_counties |> filter(statefp == "15") |> st_scale(1.5) |> st_shift(c(5200000, -1400000)) |> st_set_crs(2163)

  bind_rows(mainland, alaska, hawaii)
})

# ─────────────── Define variables ───────────────
raw_comp_vars <- c("marstat_comp_k", "placdth_comp_k", "educ_comp_k",
                   "mandeath_comp_k", "age_comp_k", "sex_comp_k", "race_comp_k")

derived_pct_vars <- c("pct_overdose_unspec", paste0("pct_", raw_comp_vars), "overall_completeness_pct")

vars_to_map <- c(
  "prop_garbage", "prop_light", "pct_acc_miss",
  "pct_overdose_unspec", paste0("pct_", raw_comp_vars),
  "overall_completeness_pct"
)

# ─────────────── Calculate derived variables and 5-year averages ───────────────
dq_clean <- dq |>
  filter(!is.na(time_window)) |>
  mutate(
    pct_overdose_unspec = if_else(overd_n > 0, overdose_unspec_k / overd_n * 100, NA_real_),
    pct_acc_miss = if_else(acc_n > 0, acc_miss_k / acc_n * 100, NA_real_),
    across(all_of(raw_comp_vars), ~ .x / n_cert * 100, .names = "pct_{.col}"),
    overall_completeness_pct = 100 * (
      (is.na(marstat_comp_k) | marstat_comp_k == 0) &
      (is.na(placdth_comp_k) | placdth_comp_k == 0) &
      (is.na(educ_comp_k) | educ_comp_k == 0 | year < 2006) &
      (is.na(mandeath_comp_k) | mandeath_comp_k == 0) &
      (is.na(age_comp_k) | age_comp_k == 0) &
      (is.na(sex_comp_k) | sex_comp_k == 0) &
      (is.na(race_comp_k) | race_comp_k == 0)
    )
  ) |>
  filter(year >= 2006 | is.na(educ_comp_k))

dq_avg_list <- map(vars_to_map, function(var) {
  dq_clean |>
    group_by(countyrs_fips, time_window) |>
    summarise(
      !!sym(var) := if (all(is.na(.data[[var]]))) NA_real_ else mean(.data[[var]], na.rm = TRUE),
      .groups = "drop"
    )
})

dq_avg <- reduce(dq_avg_list, full_join, by = c("countyrs_fips", "time_window"))

# ─────────────── Join to shapefiles ───────────────
joined_by_period <- map2(county_shapes_by_window, names(county_shapes_by_window), function(shapes, win) {
  dq_sub <- dq_avg |> filter(time_window == win)
  left_join(shapes, dq_sub, by = c("countyrs" = "countyrs_fips"))
}) |> set_names(names(county_shapes_by_window))

# ─────────────── Map function ───────────────
make_map <- function(sf_data, var, title = NULL, palette = "RdYlBu") {
  states <- tigris::states(cb = TRUE, class = "sf") |> st_transform(2163)
fill_scale <- if (var == "prop_garbage") {
  scale_fill_distiller(
    palette = palette,
    limits = c(0.05, 0.15),
    oob = scales::squish,
    direction = -1,
    na.value = "grey90"
  )
} else if (var == "prop_light") {
  scale_fill_distiller(
    palette = palette,
    limits = c(0.05, 0.20),
    oob = scales::squish,
    direction = -1,
    na.value = "grey90"
  )
} else if (var == "pct_overdose_unspec") {
  scale_fill_distiller(
    palette = palette,
    limits = c(0, 75),
    oob = scales::squish,
    direction = -1,
    na.value = "grey90"
  )
} else if (var == "pct_placdth_comp_k") {
  scale_fill_distiller(
    palette = palette,
    limits = c(99, 100),
    oob = scales::squish,
    direction = -1,
    na.value = "grey90"
  )
} else if (var %in% c("pct_age_comp_k", "pct_sex_comp_k", "pct_race_comp_k")) {
  scale_fill_distiller(
    palette = palette,
    limits = c(99, 100),
    oob = scales::squish,
    direction = -1,
    na.value = "grey90"
  )
} else if (startsWith(var, "pct_") || var == "overall_completeness_pct") {
  scale_fill_distiller(
    palette = palette,
    limits = c(0, 100),
    oob = scales::squish,
    direction = -1,
    na.value = "grey90"
  )
} else {
  scale_fill_distiller(
    palette = palette,
    oob = scales::squish,
    na.value = "grey90",
    direction = -1
  )
}

  ggplot() +
    geom_sf(data = sf_data, aes(fill = .data[[var]]), color = NA) +
    geom_sf(data = states, fill = NA, color = "white", linewidth = 0.3) +
    fill_scale +
    coord_sf(xlim = c(-2500000, 2500000), ylim = c(-2200000, 730000), expand = FALSE) +
    labs(title = title %||% var, fill = NULL) +
    theme_void() +
    theme(
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
      legend.text = element_text(size = 9)
    )
}

# ─────────────── Save maps ───────────────
output_dir <- "/Users/amymann/Documents/Data Quality Project/data_quality/figures/5yr_avg"
dir.create(output_dir, showWarnings = FALSE, recursive = TRUE)

walk(vars_to_map, function(var) {
  walk(names(joined_by_period), function(win) {
    joined_sf <- joined_by_period[[win]]

    map_plot <- make_map(joined_sf, var = var, title = paste(var, win))
    ggsave(
      filename = file.path(output_dir, paste0(var, "_", win, ".png")),
      plot = map_plot,
      width = 8,
      height = 6,
      dpi = 320
    )
  })
})
```
Temporality stable groupings
```{r}
# ──────────────────────────────────────────────────────────────
# 0 · Setup – packages, paths, helpers
# ──────────────────────────────────────────────────────────────
required <- c("sf", "tigris", "readr", "dplyr", "stringr", "tidyr",
              "purrr", "ggplot2", "viridis", "patchwork")
missing <- setdiff(required, rownames(installed.packages()))
if (length(missing)) install.packages(missing)
invisible(lapply(required, library, character.only = TRUE))
options(tigris_use_cache = TRUE, tigris_class = "sf")

comp_vars_pct <- c("pct_marstat_comp_k", "pct_placdth_comp_k", "pct_educ_comp_k", "pct_mandeath_comp_k","pct_age_comp_k", "pct_sex_comp_k", "pct_race_comp_k")

vars_to_map <- c(
  "prop_garbage", "prop_light", "pct_acc_miss", "pct_overd_miss",  "pct_gc_I64", "pct_gc_C_misc", "pct_gc_I10", "pct_gc_R_misc", "pct_gc_N19", "pct_gc_J80", comp_vars_pct
)
# ──────────────────────────────────────────────────────────────
# 1 · Load IHME temporally-stable county groupings
# ──────────────────────────────────────────────────────────────
cw_path   <- here::here("data_raw", "ihme_fips.rda")
cw_names  <- load(cw_path)
cw_obj    <- get(cw_names[1])

ihme_xwalk <- cw_obj |>
  mutate(
    fips        = str_pad(as.character(orig_fips), 5, pad = "0"),
    stable_fips = str_pad(as.character(ihme_fips), 5, pad = "0")
  ) |>
  select(fips, stable_fips) |>
  distinct()

# ──────────────────────────────────────────────────────────────
# 2 · Load & preprocess county-year data
# ──────────────────────────────────────────────────────────────
dq <- read_csv(here::here("data", "county_year_quality_metrics.csv"), show_col_types = FALSE)

dq <- dq |>
  mutate(
    year        = as.integer(year),
    time_window = case_when(
      year >= 1999 & year <= 2004 ~ "1999_2004",
      year >= 2005 & year <= 2010 ~ "2005_2010",
      year >= 2011 & year <= 2017 ~ "2011_2017",
      year >= 2020 & year <= 2022 ~ "2020_2022",
      TRUE ~ NA_character_
    )
  )

# ──────────────────────────────────────────────────────────────
# 3 · Robust FIPS parsing (hybrid logic: NCHS for ≤2002, state_abbr for ≥2003)
# ──────────────────────────────────────────────────────────────

# Lookup for 2003+ (state abbreviations ➜ FIPS)
state_fips_lookup <- tibble::tribble(
  ~state_abbr, ~state_fips,
  "AL", "01", "AK", "02", "AZ", "04", "AR", "05", "CA", "06", "CO", "08", "CT", "09",
  "DE", "10", "DC", "11", "FL", "12", "GA", "13", "HI", "15", "ID", "16", "IL", "17",
  "IN", "18", "IA", "19", "KS", "20", "KY", "21", "LA", "22", "ME", "23", "MD", "24",
  "MA", "25", "MI", "26", "MN", "27", "MS", "28", "MO", "29", "MT", "30", "NE", "31",
  "NV", "32", "NH", "33", "NJ", "34", "NM", "35", "NY", "36", "NC", "37", "ND", "38",
  "OH", "39", "OK", "40", "OR", "41", "PA", "42", "RI", "44", "SC", "45", "SD", "46",
  "TN", "47", "TX", "48", "UT", "49", "VT", "50", "VA", "51", "WA", "53", "WV", "54",
  "WI", "55", "WY", "56", "PR", "72"
)

# Existing lookup for ≤2002 (NCHS ➜ FIPS)
nchs_to_fips_state_lookup <- tibble::tribble(
  ~nchs_code, ~fips_code,
  "01", "01", "02", "02", "03", "04", "04", "05", "05", "06", "06", "08",
  "07", "09", "08", "10", "09", "11", "10", "12", "11", "13", "12", "15",
  "13", "16", "14", "17", "15", "18", "16", "19", "17", "20", "18", "21",
  "19", "22", "20", "23", "21", "24", "22", "25", "23", "26", "24", "27",
  "25", "28", "26", "29", "27", "30", "28", "31", "29", "32", "30", "33",
  "31", "34", "32", "35", "33", "36", "34", "37", "35", "38", "36", "39",
  "37", "40", "38", "41", "39", "42", "40", "44", "41", "45", "42", "46",
  "43", "47", "44", "48", "45", "49", "46", "50", "47", "51", "48", "53",
  "49", "54", "50", "55", "51", "56", "52", "72"
)

# Main logic
dq <- dq |>
  mutate(
    countyrs_chr = as.character(countyrs),
    year = as.integer(year),

    state_code = substr(countyrs_chr, 1, 2),
    county_code = substr(countyrs_chr, 3, 5),

    # Use NCHS mapping for ≤2002
    countyrs_fips = case_when(
      year <= 2002 ~ paste0(
        nchs_to_fips_state_lookup$fips_code[
          match(state_code, nchs_to_fips_state_lookup$nchs_code)
        ],
        county_code
      ),
      TRUE ~ NA_character_
    ),

    # For ≥2003, extract state abbrev and county code separately
    state_abbr = if_else(year > 2002, substr(countyrs_chr, 1, 2), NA_character_),
    county_part = if_else(year > 2002, substr(countyrs_chr, 3, 5), NA_character_)
  ) |>
  left_join(state_fips_lookup, by = "state_abbr") |>
  mutate(
    countyrs_fips = if_else(
      is.na(countyrs_fips),
      paste0(state_fips, county_part),
      countyrs_fips
    )
  )

dq <- dq |>
  mutate(across(
    ends_with("_comp_k"),
    ~ 100 * (.x / n_cert),
    .names = "pct_{.col}"
  ))
# ──────────────────────────────────────────────────────────────
# 4 · IHME stable group join + fallback
# ──────────────────────────────────────────────────────────────
dq <- dq |>
  left_join(ihme_xwalk, by = c("countyrs_fips" = "fips")) |>
  mutate(
    stable_fips = coalesce(stable_fips, countyrs_fips)
  )

# ──────────────────────────────────────────────────────────────
# 5 · 5-year averages by IHME stable FIPS
# ──────────────────────────────────────────────────────────────
dq_avg <- dq %>%
  group_by(stable_fips, time_window) %>%
  summarise(
    across(all_of(vars_to_map), ~ mean(.x, na.rm = TRUE)),
    n_years = n(),
    .groups = "drop"
  )

# ──────────────────────────────────────────────────────────────
# 6 · Time-window-specific shapefiles + merge with dq_avg
# ──────────────────────────────────────────────────────────────
crs_proj <- 2163
shapefile_years <- c("1999_2004" = 2000, "2005_2010" = 2010, "2011_2017" = 2015, "20_2022" = 2020)

# Helper: shift and scale
st_shift <- function(x, offset) {
  st_geometry(x) <- st_geometry(x) + offset
  x
}

st_scale <- function(x, factor) {
  centroid <- st_centroid(st_union(x))
  st_geometry(x) <- (st_geometry(x) - centroid) * factor + centroid
  x
}

county_shapes_by_window <- purrr::map(shapefile_years, function(year) {
  us_counties <- counties(year = year, cb = TRUE, class = "sf") |>
    st_zm(drop = TRUE, what = "ZM") |>
    st_transform(crs_proj)
  
  if ("GEOID" %in% names(us_counties)) {
    us_counties <- us_counties |> mutate(countyrs = GEOID)
  } else {
    us_counties <- us_counties |> mutate(
      countyrs = paste0(
        str_pad(as.character(STATE), 2, pad = "0"),
        str_pad(as.character(COUNTY), 3, pad = "0")
      )
    )
  }

  us_counties <- us_counties |>
    select(countyrs, geometry) |>
    left_join(ihme_xwalk, by = c("countyrs" = "fips")) |>
    mutate(
      countyrs = as.character(countyrs),
      stable_fips = coalesce(stable_fips, countyrs)
    ) |>
    group_by(stable_fips) |>
    summarise(geometry = st_union(geometry), .groups = "drop") |>
    st_set_crs(crs_proj)

  alaska <- us_counties |> filter(substr(stable_fips, 1, 2) == "02") |>
    st_scale(0.4) |> st_shift(c(1300000, -4900000)) |> st_set_crs(crs_proj)

  hawaii <- us_counties |> filter(substr(stable_fips, 1, 2) == "15") |>
    st_scale(1.5) |> st_shift(c(5200000, -1400000)) |> st_set_crs(crs_proj)

  mainland <- us_counties |> filter(!substr(stable_fips, 1, 2) %in% c("02", "15", "72"))

  bind_rows(mainland, alaska, hawaii)
})

# Join to dq_avg for each time period
joined_by_period <- map2(
  county_shapes_by_window,
  names(county_shapes_by_window),
  ~ left_join(.x, dq_avg %>% filter(time_window == .y), by = "stable_fips")
)

# ──────────────────────────────────────────────────────────────
# 7 · Mapping helper (identical to your original)
# ──────────────────────────────────────────────────────────────
make_map <- function(sf_data, var, title = NULL, palette = "RdYlBu") {
  states <- tigris::states(cb = TRUE, class = "sf") |> st_transform(2163)

  fill_scale <- if (var == "prop_garbage") {
  scale_fill_distiller(
    palette = palette,
    limits = c(0.05, 0.15),
    oob = scales::squish,
    direction = -1,
    na.value = "grey90"
  )
} else if (var == "prop_light") {
  scale_fill_distiller(
    palette = palette,
    limits = c(0.03, 0.10),
    oob = scales::squish,
    direction = -1,
    na.value = "grey90"
  )
} else if (var == "pct_overd_miss") {
  scale_fill_distiller(
    palette = palette,
    limits = c(0, 0.75),
    oob = scales::squish,
    direction = -1,
    na.value = "grey90"
  )
} else if (var == "pct_acc_miss") {
  scale_fill_distiller(
    palette = palette,
    limits = c(0, 0.75),
    oob = scales::squish,
    direction = -1,
    na.value = "grey90"
  )
} else if (var == "pct_mandeath_comp_k") {
  scale_fill_distiller(
    palette = palette,
    limits = c(5, 20),
    oob = scales::squish,
    direction = 1,
    na.value = "grey90"
  )
} else if (var == "pct_placdth_comp_k") {
  scale_fill_distiller(
    palette = palette,
    limits = c(98, 100),
    oob = scales::squish,
    direction = 1,
    na.value = "grey90"
  )
} else if (var == "pct_educ_comp_k") {
  scale_fill_distiller(
    palette = palette,
    limits = c(0, 100),
    oob = scales::squish,
    direction = 1,
    na.value = "grey90"
  )
} else if (var == "pct_marstat_comp_k") {
  scale_fill_distiller(
    palette = palette,
    limits = c(97, 100),
    oob = scales::squish,
    direction = 1,
    na.value = "grey90"
  )
} else if (var %in% c("pct_age_comp_k", "pct_sex_comp_k", "pct_race_comp_k")) {
  scale_fill_distiller(
    palette = palette,
    limits = c(99.5, 100),
    oob = scales::squish,
    direction = 1,
    na.value = "grey90"
  )
} else if (var == "pct_gc_I64") {
  scale_fill_distiller(
    palette = palette,
    limits = c(0.01, 0.05),
    oob = scales::squish,
    direction = -1,
    na.value = "grey90"
  )
} else if (var == "pct_gc_C_misc") {
  scale_fill_distiller(
    palette = palette,
    limits = c(0.005, 0.03),
    oob = scales::squish,
    direction = -1,
    na.value = "grey90"
  )
} else if (var == "pct_gc_I10") {
  scale_fill_distiller(
    palette = palette,
    limits = c(0, 0.02),
    oob = scales::squish,
    direction = -1,
    na.value = "grey90"
  )
} else if (var == "pct_gc_R_misc") {
  scale_fill_distiller(
    palette = palette,
    limits = c(0, 0.03),
    oob = scales::squish,
    direction = -1,
    na.value = "grey90"
  )
} else if (var == "pct_gc_N19") {
  scale_fill_distiller(
    palette = palette,
    limits = c(0, 0.025),
    oob = scales::squish,
    direction = -1,
    na.value = "grey90"
  )
} else if (var == "pct_gc_J80") {
  scale_fill_distiller(
    palette = palette,
    limits = c(0, 0.005),
    oob = scales::squish,
    direction = -1,
    na.value = "grey90"
  )
} else if (startsWith(var, "pct_") || var == "overall_completeness_pct") {
  scale_fill_distiller(
    palette = palette,
    limits = c(0, 100),
    oob = scales::squish,
    direction = 1,
    na.value = "grey90"
  )
} else {
  scale_fill_distiller(
    palette = palette,
    oob = scales::squish,
    na.value = "grey90",
    direction = -1
  )
}

  ggplot() +
    geom_sf(data = sf_data, aes(fill = .data[[var]]), colour = NA) +
    geom_sf(data = states, fill = NA, colour = "white", linewidth = 0.3) +
    fill_scale +
    coord_sf(xlim = c(-2500000, 2500000),
             ylim = c(-2200000, 730000),
             expand = FALSE) +
    labs(title = title %||% var, fill = NULL) +
    theme_void() +
    theme(
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
      legend.text = element_text(size = 9)
    )
}

# ──────────────────────────────────────────────────────────────
# 8 · Save maps
# ──────────────────────────────────────────────────────────────
output_dir <- "/Users/amymann/Documents/Data Quality Project/data_quality/figures/5yr_avg_stable"
dir.create(output_dir, showWarnings = FALSE, recursive = TRUE)

walk(vars_to_map, function(var) {
  walk(names(joined_by_period), function(win) {
    map_plot <- make_map(joined_by_period[[win]], var, paste(var, win))
    ggsave(
      filename = file.path(output_dir, paste0(var, "_", win, ".png")),
      plot     = map_plot,
      width    = 8, height = 6, dpi = 320
    )
  })
})

```
Relationship between rural and garbage
```{r}
# 0 · Load packages -------------------------------------------------------
library(dplyr)
library(stringr)
library(ggplot2)
library(scales)
library(tigris)
library(tidycensus)
library(readr)
library(here)

# 1 · Load your data ------------------------------------------------------
dq <- read_csv(here("data", "county_year_quality_metrics.csv"),
               show_col_types = FALSE)

# 2 · Build FIPS lookup ---------------------------------------------------
fips_lookup <- fips_codes %>%
  mutate(
    county_code_3 = sprintf("%03d", as.integer(county_code)),
    custom_code   = paste0(state, county_code_3),
    GEOID         = paste0(state_code, county_code)
  ) %>%
  select(custom_code, GEOID)

# 3 · Convert county codes to GEOID ---------------------------------------
dq_all <- dq %>%
  mutate(
    GEOID = case_when(
      str_detect(countyrs, "^[0-9]{5}$") ~ countyrs,
      str_detect(countyrs, "^[A-Z]{2}[0-9]{3}$") ~ fips_lookup$GEOID[match(countyrs, fips_lookup$custom_code)],
      TRUE ~ NA_character_
    )
  )

cat("Counties without valid GEOID:", sum(is.na(dq_all$GEOID)), "\n")

# 4 · Get 2022 population estimates ---------------------------------------
census_api_key("671b64055fc192103cbc199d2dff91b46d9cc781", overwrite = FALSE)

pop22 <- get_acs(
  geography = "county",
  variables = "B01003_001",
  year = 2022,
  survey = "acs5"
) %>%
  select(GEOID, pop_2022 = estimate)

# 5 · Define county size buckets ------------------------------------------
cuts   <- c(0, 50000, 100000, 250000, 1000000, Inf)
labels <- c("<50k", "50–100k", "100–250k", "250k–1M", "≥1M")

county_sizes <- pop22 %>%
  mutate(size_bucket = cut(pop_2022, breaks = cuts, labels = labels, right = FALSE)) %>%
  select(GEOID, pop_2022, size_bucket)

# 6 · Join population and size to main data -------------------------------
dq_all <- dq_all %>%
  left_join(pop22, by = "GEOID") %>%
  left_join(county_sizes %>% select(GEOID, size_bucket), by = "GEOID")

# 7 · Indicators to plot --------------------------------------------------
indicators <- c(
  "prop_garbage",
  "prop_light",
  "pct_overd_miss",
  "pct_acc_miss")

# 8 · Time trends by size bucket ------------------------------------------
for (var in indicators) {
  ts_df <- dq_all %>%
    filter(!is.na(size_bucket)) %>%
    group_by(year, size_bucket) %>%
    summarise(avg_prop = mean(.data[[var]], na.rm = TRUE), .groups = "drop")
  
  g <- ggplot(ts_df, aes(year, avg_prop, colour = size_bucket)) +
    geom_line(linewidth = 1) +
    scale_y_continuous(labels = percent_format(accuracy = 0.1)) +
    labs(
      title = paste("Trend of", gsub("_", " ", var), "by county size"),
      x = NULL,
      y = "Mean percentage",
      colour = "2022 size bucket"
    ) +
    theme_bw()
  
  print(g)
  
  ggsave(
    filename = here("figures", paste0("trend_", var, "_by_size_bucket.png")),
    plot = g,
    width = 7, height = 4, dpi = 300
  )
}

# 9 · Scatterplots: pop vs indicator (2022) -------------------------------
scatter_data <- dq_all %>%
  filter(year == 2022, !is.na(pop_2022))

for (var in indicators) {
  scatter_df <- scatter_data %>%
    filter(!is.na(.data[[var]]))
  
  g <- ggplot(scatter_df, aes(x = pop_2022, y = .data[[var]])) +
    geom_point(alpha = 0.6) +
    scale_x_log10(labels = comma) +
    scale_y_continuous(labels = percent_format(accuracy = 0.1)) +
    labs(
      title = paste("County population vs", gsub("_", " ", var), "(2022)"),
      x = "County population (log10 scale)",
      y = paste("Proportion:", gsub("_", " ", var))
    ) +
    theme_bw()
  
  print(g)
  
  ggsave(
    filename = here("figures", paste0("scatter_", var, "_vs_population_2022.png")),
    plot = g,
    width = 7, height = 4, dpi = 300
  )
}
```








