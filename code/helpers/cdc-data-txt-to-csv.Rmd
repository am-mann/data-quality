# ──────────────────────────────────────────────────────────────
# 0.  LOAD LIBRARIES
# ──────────────────────────────────────────────────────────────
library(tidyverse)   # readr, dplyr, stringr, tibble …
library(pdftools)    # pdf_text()

# ──────────────────────────────────────────────────────────────
# 1.  EXTRACT FULL LAYOUT (ordered by start byte)
# ──────────────────────────────────────────────────────────────
extract_layout <- function(pdf_path) {
  txt <- pdf_text(pdf_path)
  lines <- unlist(str_split(paste(txt, collapse = "\n"), "\n"))
  
  pos_lines <- lines[str_detect(lines, "^\\s*\\d{1,3}(?:-\\d{1,3})?\\s+\\d+\\s+")]
  m <- str_match(pos_lines,
                 "^\\s*(\\d+)(?:-(\\d+))?\\s+\\d+\\s+([^\\s]+)")
  
  tibble(
    start = as.integer(m[,2]),
    end   = as.integer(ifelse(m[,3]=="" | is.na(m[,3]), m[,2], m[,3])),
    name  = tolower(m[,4])
  ) %>%                                    # lower-case to match CSV header
    filter(!str_detect(name, "^filler")) %>%
    arrange(start)                         # <— critical!
}

layout_full <- extract_layout(
  "/Users/amymann/Documents/Data Quality Project/data/txt/UserGuide2015.pdf"
)

spec_full <- fwf_positions(
  start     = layout_full$start,
  end       = layout_full$end,
  col_names = layout_full$name
)

# ──────────────────────────────────────────────────────────────
# 2.  TEMPLATE COLUMN LIST (order we ultimately want)
# ──────────────────────────────────────────────────────────────
template_cols <- names(
  read_csv(
    "/Users/amymann/Documents/Data Quality Project/data_quality/first_few_lines.csv",
    n_max = 0
  )
)

# ──────────────────────────────────────────────────────────────
# 3.  PREP OUTPUT CSV (write header only once)
# ──────────────────────────────────────────────────────────────
out_path <- "/Users/amymann/Documents/Data Quality Project/data/sample_test.csv"
if (file.exists(out_path)) file.remove(out_path)
writeLines(paste(template_cols, collapse = ","), out_path)

# ──────────────────────────────────────────────────────────────
# 4.  STREAM TXT → CSV IN 10 k-LINE CHUNKS
# ──────────────────────────────────────────────────────────────
readr::read_lines_chunked(
  file       = "/Users/amymann/Documents/Data Quality Project/data/txt/Nat2015PublicUS.c20160517.r20160907.txt",
  chunk_size = 10000,
  callback   = readr::SideEffectChunkCallback$new(function(lines, pos) {
    # 4a. parse the raw lines using the FULL spec (sorted by start)
    df_raw <- readr::read_fwf(
      I(lines),
      col_positions = spec_full,
      col_types     = readr::cols(.default = "c")
    )
    
# 4b. Keep & order template columns, allowing missing ones (filled with NA)
existing_cols <- intersect(template_cols, names(df_raw))
missing_cols <- setdiff(template_cols, names(df_raw))

# Select existing columns, and fill missing columns with NA
df_out <- df_raw %>%
  select(all_of(existing_cols)) %>%
  bind_cols(set_names(rep(list(NA_character_), length(missing_cols)), missing_cols)) %>%
  select(all_of(template_cols))  # re-order to exactly match the template

    
    # 4c. append to CSV
    readr::write_csv(df_out, out_path, append = TRUE)
  })
)

cat("✓ Done. Data written to:\n", out_path, "\n")
file <- read_csv("/Users/amymann/Documents/Data Quality Project/data/mortality_sample_test.csv")

