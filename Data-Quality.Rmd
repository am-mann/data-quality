---
title: "Data Quality Project"
output: html_notebook
---

Load packages and summarize data.
```{r}
library(arrow)
library(dplyr)
library(tidyr)
library(purrr)
library(stringr)
library(ggplot2)
library(readr)
library(janitor) 

parquet_dir   <- "/Users/amymann/Documents/Data Quality Project/data/parquet"
garbage_path  <- "/Users/amymann/Documents/Data Quality Project/data_quality/cause-codes/gbd_garbage_codes_with_descr.csv"

needed_cols   <- c("year", "sex", "race", "marstat", "placdth", "ucod", "ranum")
years_wanted  <- 1999:2023

garbage_lu <- read_csv(garbage_path, show_col_types = FALSE) %>% 
  transmute(
    icd10        = str_to_upper(icd10),
    gbd_severity = as.integer(gbd_severity)        # 1-4
  )

clean_icd <- function(x) str_remove_all(str_to_upper(x), "[^A-Z0-9\\.]")

summarise_file <- function(path) {
  read_parquet(path, col_select = all_of(needed_cols)) %>% 
    mutate(
      year  = as.integer(year),
      icd10 = clean_icd(ucod)
    ) %>% 
    filter(year %in% years_wanted) %>% 
    left_join(garbage_lu, by = "icd10") %>% 
    
    # ── flag garbage deaths once ──────────────────────────────────────────────
    mutate(is_garbage = !is.na(gbd_severity)) %>%      # TRUE for garbage-coded
    select(-any_of(c("ucod", "icd10", "gbd_severity"))) %>% 
    
    # ── reshape so every demo var becomes its own column `variable` / `level` ─
    pivot_longer(
      -c(year, is_garbage),                            # keep flags & year
      names_to  = "variable",
      values_to = "level",
      values_transform = list(level = as.character)
    ) %>% 
    filter(!is.na(level)) %>% 
    
    # ── compute totals + garbage share for each year-variable-level ───────────
    group_by(year, variable, level) %>% 
    summarise(
      total_n        = n(),
      garbage_n      = sum(is_garbage),
      prop_garbage   = garbage_n / total_n,            # ← requested metric
      .groups        = "drop"
    )
}


ts_long <- list.files(parquet_dir, "\\.parquet$", full.names = TRUE) %>% 
map_dfr(summarise_file)            
```

Plots of proportion of garbage codes overtime and average severity overtime 
```{r}
fig_dir <- "/Users/amymann/Documents/Data Quality Project/data_quality/figures"
dir.create(fig_dir, recursive = TRUE, showWarnings = FALSE)

ts_garbage <- ts_long %>%
  filter(variable == "garbage") %>% 
  group_by(year) %>% 
  mutate(prop = n / sum(n)) %>% 
  ungroup()

prop_garbage_plot<-ts_garbage %>%
  filter(level == "Garbage") %>% 
  ggplot(aes(year, prop)) +
    geom_line(color = "black") +
    scale_y_continuous(labels = scales::percent) +
    labs(title = "Proportion of deaths classified as garbage",
         x = NULL, y = "Proportion of deaths")

avg_severity_ts <- ts_long %>% 
  filter(variable == "gbd_severity", level != "0-Non") %>% 
  mutate(
    severity = as.numeric(level),
    n        = as.numeric(n)) %>% 
  group_by(year) %>% 
  summarise(
    total_deaths = sum(n),
    avg_severity = sum(severity * n) / total_deaths,
    .groups      = "drop" )

severity_plot <- ggplot(avg_severity_ts, aes(year, avg_severity)) +
  geom_line() +
  scale_y_continuous(limits = c(1, 4)) +
  labs(title = "Average garbage-code severity, 1999–2023",
       x = NULL, y = "Average severity (scale 1-4)")

ggsave(file.path(fig_dir, "prop_garbage_over_time.png"),
       plot   = prop_garbage_plot,
       width  = 7, height = 4, dpi = 300)

ggsave(file.path(fig_dir, "avg_garbage_severity_over_time.png"),
       plot   = severity_plot,
       width  = 7, height = 4, dpi = 300)

```

Demographics v.s. proportion garbage codes overtime
```{r}
# assumes `ts_demo` and `fig_dir` already exist
demo_vars <- c("sex", "race", "marstat", "placdth", "educ2003")

walk(demo_vars, \(v) {
  p <- ggplot(filter(ts_long, variable == v),
              aes(year, prop_garbage, colour = level)) +
         geom_line() +
         scale_y_continuous(labels = percent) +
         labs(title  = paste("Proportion of garbage-coded deaths –", v),
              x = NULL, y = "Proportion of deaths", colour = v)

  ggsave(file.path(fig_dir, paste0("prop_garbage_by_", v, ".png")),
         plot = p, width = 7, height = 4, dpi = 300)
})

```




